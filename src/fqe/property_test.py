#   Copyright 2019 Quantum Simulation Technologies Inc.
#
#   Licensed under the Apache License, Version 2.0 (the "License");
#   you may not use this file except in compliance with the License.
#   You may obtain a copy of the License at
#
#       http://www.apache.org/licenses/LICENSE-2.0
#
#   Unless required by applicable law or agreed to in writing, software
#   distributed under the License is distributed on an "AS IS" BASIS,
#   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
#   See the License for the specific language governing permissions and
#   limitations under the License.

import unittest

import fqe
from fqe.wavefunction import Wavefunction
from fqe.fqe_data import FqeData
from scipy import special
import numpy 
from numpy import linalg


class TestFQE(unittest.TestCase):


    def setUp(self):
        self.E_LiH_ref = -8.87771987
        self.norb = 6
        self.nalpha = 2
        self.nbeta = 2
        self.h1e = numpy.array(\
         [[-4.72842135 , 0.10568279 , 0.16702011 ,-0.00000000 , 0.00000000 ,-0.03428713 ],\
          [ 0.10568279 ,-1.49457744 , 0.03303310 , 0.00000000 , 0.00000000 ,-0.05410241 ],\
          [ 0.16702011 , 0.03303310 ,-1.12588339 ,-0.00000000 ,-0.00000000 , 0.03053996 ],\
          [-0.00000000 , 0.00000000 ,-0.00000000 ,-1.13626763 ,-0.00000000 , 0.00000000 ],\
          [ 0.00000000 , 0.00000000 ,-0.00000000 ,-0.00000000 ,-1.13626763 , 0.00000000 ],\
          [-0.03428713 ,-0.05410241 , 0.03053996 , 0.00000000 , 0.00000000 ,-0.95010403 ]])
        self.h2e = numpy.array(\
         [[[[-0.82927576 , 0.05597057 , 0.06926596 ,-0.00000000 , 0.00000000 ,-0.02631908 ],\
            [ 0.05597057 ,-0.00669842 ,-0.00561518 , 0.00000000 ,-0.00000000 , 0.00443919 ],\
            [ 0.06926596 ,-0.00561518 ,-0.01082783 , 0.00000000 ,-0.00000000 , 0.00115433 ],\
            [-0.00000000 , 0.00000000 , 0.00000000 ,-0.00490897 ,-0.00000000 ,-0.00000000 ],\
            [ 0.00000000 ,-0.00000000 ,-0.00000000 ,-0.00000000 ,-0.00490897 , 0.00000000 ],\
            [-0.02631908 , 0.00443919 , 0.00115433 ,-0.00000000 , 0.00000000 ,-0.00424586 ]],
           [[ 0.05597057 ,-0.18365505 ,-0.00667306 , 0.00000000 , 0.00000000 , 0.02045706 ],\
            [-0.00669842 ,-0.00312917 , 0.00168160 , 0.00000000 , 0.00000000 ,-0.00237063 ],\
            [-0.00561518 , 0.00796285 ,-0.00008961 ,-0.00000000 ,-0.00000000 ,-0.00025079 ],\
            [ 0.00000000 , 0.00000000 ,-0.00000000 ,-0.00374626 ,-0.00000000 ,-0.00000000 ],\
            [-0.00000000 , 0.00000000 , 0.00000000 ,-0.00000000 ,-0.00374626 ,-0.00000000 ],\
            [ 0.00443919 , 0.00340244 ,-0.00083494 ,-0.00000000 ,-0.00000000 ,-0.00006379 ]],
           [[ 0.06926596 ,-0.00667306 ,-0.19782696 ,-0.00000000 ,-0.00000000 ,-0.00882298 ],\
            [-0.00561518 , 0.00168160 , 0.00553235 , 0.00000000 , 0.00000000 , 0.00184650 ],\
            [-0.01082783 ,-0.00008961 ,-0.00091662 ,-0.00000000 , 0.00000000 ,-0.00220044 ],\
            [ 0.00000000 ,-0.00000000 ,-0.00000000 ,-0.00512844 ,-0.00000000 , 0.00000000 ],\
            [-0.00000000 , 0.00000000 , 0.00000000 ,-0.00000000 ,-0.00512844 ,-0.00000000 ],\
            [ 0.00115433 ,-0.00083494 ,-0.00520404 , 0.00000000 ,-0.00000000 ,-0.00215110 ]],
           [[-0.00000000 , 0.00000000 ,-0.00000000 ,-0.19815946 ,-0.00000000 , 0.00000000 ],\
            [ 0.00000000 , 0.00000000 , 0.00000000 , 0.00218343 , 0.00000000 , 0.00000000 ],\
            [ 0.00000000 ,-0.00000000 ,-0.00000000 , 0.00248687 , 0.00000000 , 0.00000000 ],\
            [-0.00490897 ,-0.00374626 ,-0.00512844 , 0.00000000 ,-0.00000000 , 0.00305410 ],\
            [-0.00000000 ,-0.00000000 ,-0.00000000 , 0.00000000 , 0.00000000 , 0.00000000 ],\
            [-0.00000000 ,-0.00000000 , 0.00000000 ,-0.00028653 ,-0.00000000 ,-0.00000000 ]],
           [[ 0.00000000 , 0.00000000 ,-0.00000000 ,-0.00000000 ,-0.19815946 , 0.00000000 ],\
            [-0.00000000 , 0.00000000 , 0.00000000 , 0.00000000 , 0.00218343 , 0.00000000 ],\
            [-0.00000000 ,-0.00000000 , 0.00000000 , 0.00000000 , 0.00248687 ,-0.00000000 ],\
            [-0.00000000 ,-0.00000000 ,-0.00000000 ,-0.00000000 ,-0.00000000 , 0.00000000 ],\
            [-0.00490897 ,-0.00374626 ,-0.00512844 , 0.00000000 ,-0.00000000 , 0.00305410 ],\
            [ 0.00000000 ,-0.00000000 ,-0.00000000 ,-0.00000000 ,-0.00028653 ,-0.00000000 ]],
           [[-0.02631908 , 0.02045706 ,-0.00882298 , 0.00000000 , 0.00000000 ,-0.18087141 ],\
            [ 0.00443919 ,-0.00237063 , 0.00184650 , 0.00000000 , 0.00000000 ,-0.00165839 ],\
            [ 0.00115433 ,-0.00025079 ,-0.00220044 , 0.00000000 ,-0.00000000 , 0.00566870 ],\
            [-0.00000000 ,-0.00000000 , 0.00000000 , 0.00305410 , 0.00000000 ,-0.00000000 ],\
            [ 0.00000000 ,-0.00000000 ,-0.00000000 , 0.00000000 , 0.00305410 , 0.00000000 ],\
            [-0.00424586 ,-0.00006379 ,-0.00215110 ,-0.00000000 ,-0.00000000 , 0.00151402 ]]],
          [[[ 0.05597057 ,-0.00669842 ,-0.00561518 , 0.00000000 ,-0.00000000 , 0.00443919 ],\
            [-0.18365505 ,-0.00312917 , 0.00796285 , 0.00000000 , 0.00000000 , 0.00340244 ],\
            [-0.00667306 , 0.00168160 ,-0.00008961 ,-0.00000000 , 0.00000000 ,-0.00083494 ],\
            [ 0.00000000 , 0.00000000 ,-0.00000000 ,-0.00374626 ,-0.00000000 ,-0.00000000 ],\
            [ 0.00000000 , 0.00000000 ,-0.00000000 ,-0.00000000 ,-0.00374626 ,-0.00000000 ],\
            [ 0.02045706 ,-0.00237063 ,-0.00025079 ,-0.00000000 ,-0.00000000 ,-0.00006379 ]],
           [[-0.00669842 ,-0.00312917 , 0.00168160 , 0.00000000 , 0.00000000 ,-0.00237063 ],\
            [-0.00312917 ,-0.24382891 , 0.02424747 , 0.00000000 , 0.00000000 ,-0.06352614 ],\
            [ 0.00168160 , 0.02424747 ,-0.00650698 ,-0.00000000 ,-0.00000000 , 0.01727050 ],\
            [ 0.00000000 , 0.00000000 ,-0.00000000 ,-0.01172506 ,-0.00000000 , 0.00000000 ],\
            [ 0.00000000 , 0.00000000 ,-0.00000000 ,-0.00000000 ,-0.01172506 , 0.00000000 ],\
            [-0.00237063 ,-0.06352614 , 0.01727050 , 0.00000000 , 0.00000000 ,-0.06193616 ]],
           [[-0.00561518 , 0.00168160 , 0.00553235 , 0.00000000 , 0.00000000 , 0.00184650 ],\
            [ 0.00796285 , 0.02424747 ,-0.11187654 ,-0.00000000 ,-0.00000000 , 0.02567039 ],\
            [-0.00008961 ,-0.00650698 ,-0.00370910 , 0.00000000 , 0.00000000 ,-0.00467873 ],\
            [-0.00000000 ,-0.00000000 , 0.00000000 ,-0.00963631 ,-0.00000000 ,-0.00000000 ],\
            [-0.00000000 ,-0.00000000 , 0.00000000 ,-0.00000000 ,-0.00963631 ,-0.00000000 ],\
            [-0.00025079 , 0.01727050 , 0.00614209 ,-0.00000000 ,-0.00000000 , 0.01592852 ]],
           [[ 0.00000000 , 0.00000000 , 0.00000000 , 0.00218343 , 0.00000000 , 0.00000000 ],\
            [ 0.00000000 , 0.00000000 ,-0.00000000 ,-0.13520908 ,-0.00000000 , 0.00000000 ],\
            [-0.00000000 ,-0.00000000 , 0.00000000 ,-0.00285645 ,-0.00000000 ,-0.00000000 ],\
            [-0.00374626 ,-0.01172506 ,-0.00963631 , 0.00000000 ,-0.00000000 , 0.00978740 ],\
            [-0.00000000 ,-0.00000000 ,-0.00000000 , 0.00000000 , 0.00000000 , 0.00000000 ],\
            [-0.00000000 , 0.00000000 ,-0.00000000 , 0.00801845 , 0.00000000 , 0.00000000 ]],
           [[-0.00000000 , 0.00000000 , 0.00000000 , 0.00000000 , 0.00218343 , 0.00000000 ],\
            [ 0.00000000 , 0.00000000 ,-0.00000000 ,-0.00000000 ,-0.13520908 , 0.00000000 ],\
            [ 0.00000000 ,-0.00000000 , 0.00000000 ,-0.00000000 ,-0.00285645 ,-0.00000000 ],\
            [-0.00000000 ,-0.00000000 ,-0.00000000 ,-0.00000000 , 0.00000000 , 0.00000000 ],\
            [-0.00374626 ,-0.01172506 ,-0.00963631 , 0.00000000 , 0.00000000 , 0.00978740 ],\
            [-0.00000000 , 0.00000000 ,-0.00000000 , 0.00000000 , 0.00801845 , 0.00000000 ]],
           [[ 0.00443919 ,-0.00237063 , 0.00184650 , 0.00000000 , 0.00000000 ,-0.00165839 ],\
            [ 0.00340244 ,-0.06352614 , 0.02567039 , 0.00000000 , 0.00000000 ,-0.22702098 ],\
            [-0.00083494 , 0.01727050 ,-0.00467873 ,-0.00000000 ,-0.00000000 , 0.02164705 ],\
            [-0.00000000 , 0.00000000 ,-0.00000000 , 0.00978740 , 0.00000000 , 0.00000000 ],\
            [-0.00000000 , 0.00000000 ,-0.00000000 , 0.00000000 , 0.00978740 , 0.00000000 ],\
            [-0.00006379 ,-0.06193616 , 0.01592852 , 0.00000000 , 0.00000000 ,-0.06726437 ]]],
          [[[ 0.06926596 ,-0.00561518 ,-0.01082783 , 0.00000000 ,-0.00000000 , 0.00115433 ],\
            [-0.00667306 , 0.00168160 ,-0.00008961 ,-0.00000000 , 0.00000000 ,-0.00083494 ],\
            [-0.19782696 , 0.00553235 ,-0.00091662 ,-0.00000000 , 0.00000000 ,-0.00520404 ],\
            [-0.00000000 , 0.00000000 ,-0.00000000 ,-0.00512844 ,-0.00000000 , 0.00000000 ],\
            [-0.00000000 , 0.00000000 , 0.00000000 ,-0.00000000 ,-0.00512844 ,-0.00000000 ],\
            [-0.00882298 , 0.00184650 ,-0.00220044 , 0.00000000 ,-0.00000000 ,-0.00215110 ]],
           [[-0.00561518 , 0.00796285 ,-0.00008961 ,-0.00000000 ,-0.00000000 ,-0.00025079 ],\
            [ 0.00168160 , 0.02424747 ,-0.00650698 ,-0.00000000 ,-0.00000000 , 0.01727050 ],\
            [ 0.00553235 ,-0.11187654 ,-0.00370910 , 0.00000000 , 0.00000000 , 0.00614209 ],\
            [ 0.00000000 ,-0.00000000 , 0.00000000 ,-0.00963631 ,-0.00000000 ,-0.00000000 ],\
            [ 0.00000000 ,-0.00000000 , 0.00000000 ,-0.00000000 ,-0.00963631 ,-0.00000000 ],\
            [ 0.00184650 , 0.02567039 ,-0.00467873 ,-0.00000000 ,-0.00000000 , 0.01592852 ]],
           [[-0.01082783 ,-0.00008961 ,-0.00091662 ,-0.00000000 , 0.00000000 ,-0.00220044 ],\
            [-0.00008961 ,-0.00650698 ,-0.00370910 , 0.00000000 , 0.00000000 ,-0.00467873 ],\
            [-0.00091662 ,-0.00370910 ,-0.16896750 ,-0.00000000 ,-0.00000000 ,-0.01799095 ],\
            [-0.00000000 , 0.00000000 ,-0.00000000 ,-0.02063890 ,-0.00000000 , 0.00000000 ],\
            [ 0.00000000 , 0.00000000 ,-0.00000000 ,-0.00000000 ,-0.02063890 ,-0.00000000 ],\
            [-0.00220044 ,-0.00467873 ,-0.01799095 , 0.00000000 ,-0.00000000 ,-0.01321835 ]],
           [[ 0.00000000 ,-0.00000000 ,-0.00000000 , 0.00248687 , 0.00000000 , 0.00000000 ],\
            [-0.00000000 ,-0.00000000 , 0.00000000 ,-0.00285645 ,-0.00000000 ,-0.00000000 ],\
            [-0.00000000 , 0.00000000 ,-0.00000000 ,-0.14100189 ,-0.00000000 , 0.00000000 ],\
            [-0.00512844 ,-0.00963631 ,-0.02063890 ,-0.00000000 ,-0.00000000 , 0.00686606 ],\
            [-0.00000000 ,-0.00000000 ,-0.00000000 ,-0.00000000 , 0.00000000 , 0.00000000 ],\
            [ 0.00000000 ,-0.00000000 , 0.00000000 ,-0.00109727 ,-0.00000000 ,-0.00000000 ]],
           [[-0.00000000 ,-0.00000000 , 0.00000000 , 0.00000000 , 0.00248687 ,-0.00000000 ],\
            [ 0.00000000 ,-0.00000000 , 0.00000000 ,-0.00000000 ,-0.00285645 ,-0.00000000 ],\
            [ 0.00000000 , 0.00000000 ,-0.00000000 ,-0.00000000 ,-0.14100189 , 0.00000000 ],\
            [-0.00000000 ,-0.00000000 ,-0.00000000 ,-0.00000000 ,-0.00000000 , 0.00000000 ],\
            [-0.00512844 ,-0.00963631 ,-0.02063890 , 0.00000000 ,-0.00000000 , 0.00686606 ],\
            [-0.00000000 ,-0.00000000 ,-0.00000000 ,-0.00000000 ,-0.00109727 ,-0.00000000 ]],
           [[ 0.00115433 ,-0.00025079 ,-0.00220044 , 0.00000000 ,-0.00000000 , 0.00566870 ],\
            [-0.00083494 , 0.01727050 ,-0.00467873 ,-0.00000000 ,-0.00000000 , 0.02164705 ],\
            [-0.00520404 , 0.00614209 ,-0.01799095 , 0.00000000 , 0.00000000 ,-0.12073391 ],\
            [ 0.00000000 ,-0.00000000 , 0.00000000 , 0.00686606 , 0.00000000 ,-0.00000000 ],\
            [-0.00000000 ,-0.00000000 ,-0.00000000 , 0.00000000 , 0.00686606 ,-0.00000000 ],\
            [-0.00215110 , 0.01592852 ,-0.01321835 ,-0.00000000 ,-0.00000000 , 0.02202612 ]]],
          [[[-0.00000000 , 0.00000000 , 0.00000000 ,-0.00490897 ,-0.00000000 ,-0.00000000 ],\
            [ 0.00000000 , 0.00000000 ,-0.00000000 ,-0.00374626 ,-0.00000000 ,-0.00000000 ],\
            [-0.00000000 , 0.00000000 ,-0.00000000 ,-0.00512844 ,-0.00000000 , 0.00000000 ],\
            [-0.19815946 , 0.00218343 , 0.00248687 , 0.00000000 , 0.00000000 ,-0.00028653 ],\
            [-0.00000000 , 0.00000000 , 0.00000000 ,-0.00000000 , 0.00000000 , 0.00000000 ],\
            [ 0.00000000 , 0.00000000 , 0.00000000 , 0.00305410 , 0.00000000 ,-0.00000000 ]],
           [[ 0.00000000 , 0.00000000 ,-0.00000000 ,-0.00374626 ,-0.00000000 ,-0.00000000 ],\
            [ 0.00000000 , 0.00000000 ,-0.00000000 ,-0.01172506 ,-0.00000000 , 0.00000000 ],\
            [ 0.00000000 ,-0.00000000 , 0.00000000 ,-0.00963631 ,-0.00000000 ,-0.00000000 ],\
            [ 0.00218343 ,-0.13520908 ,-0.00285645 , 0.00000000 , 0.00000000 , 0.00801845 ],\
            [ 0.00000000 ,-0.00000000 , 0.00000000 ,-0.00000000 , 0.00000000 ,-0.00000000 ],\
            [ 0.00000000 , 0.00000000 ,-0.00000000 , 0.00978740 , 0.00000000 , 0.00000000 ]],
           [[ 0.00000000 ,-0.00000000 ,-0.00000000 ,-0.00512844 ,-0.00000000 , 0.00000000 ],\
            [-0.00000000 ,-0.00000000 , 0.00000000 ,-0.00963631 ,-0.00000000 ,-0.00000000 ],\
            [-0.00000000 , 0.00000000 ,-0.00000000 ,-0.02063890 ,-0.00000000 , 0.00000000 ],\
            [ 0.00248687 ,-0.00285645 ,-0.14100189 ,-0.00000000 ,-0.00000000 ,-0.00109727 ],\
            [ 0.00000000 , 0.00000000 ,-0.00000000 ,-0.00000000 , 0.00000000 ,-0.00000000 ],\
            [ 0.00000000 ,-0.00000000 , 0.00000000 , 0.00686606 , 0.00000000 ,-0.00000000 ]],
           [[-0.00490897 ,-0.00374626 ,-0.00512844 , 0.00000000 ,-0.00000000 , 0.00305410 ],\
            [-0.00374626 ,-0.01172506 ,-0.00963631 , 0.00000000 ,-0.00000000 , 0.00978740 ],\
            [-0.00512844 ,-0.00963631 ,-0.02063890 ,-0.00000000 ,-0.00000000 , 0.00686606 ],\
            [ 0.00000000 , 0.00000000 ,-0.00000000 ,-0.15647276 ,-0.00000000 , 0.00000000 ],\
            [-0.00000000 ,-0.00000000 ,-0.00000000 , 0.00000000 ,-0.00843457 , 0.00000000 ],\
            [ 0.00305410 , 0.00978740 , 0.00686606 , 0.00000000 , 0.00000000 ,-0.00985673 ]],
           [[-0.00000000 ,-0.00000000 ,-0.00000000 ,-0.00000000 ,-0.00000000 , 0.00000000 ],\
            [-0.00000000 ,-0.00000000 ,-0.00000000 ,-0.00000000 , 0.00000000 , 0.00000000 ],\
            [-0.00000000 ,-0.00000000 ,-0.00000000 ,-0.00000000 ,-0.00000000 , 0.00000000 ],\
            [ 0.00000000 , 0.00000000 ,-0.00000000 ,-0.00000000 ,-0.13960362 , 0.00000000 ],\
            [ 0.00000000 , 0.00000000 , 0.00000000 ,-0.00843457 ,-0.00000000 ,-0.00000000 ],\
            [ 0.00000000 , 0.00000000 , 0.00000000 , 0.00000000 , 0.00000000 ,-0.00000000 ]],
           [[-0.00000000 ,-0.00000000 , 0.00000000 , 0.00305410 , 0.00000000 ,-0.00000000 ],\
            [-0.00000000 , 0.00000000 ,-0.00000000 , 0.00978740 , 0.00000000 , 0.00000000 ],\
            [ 0.00000000 ,-0.00000000 , 0.00000000 , 0.00686606 , 0.00000000 ,-0.00000000 ],\
            [-0.00028653 , 0.00801845 ,-0.00109727 , 0.00000000 , 0.00000000 ,-0.13409712 ],\
            [ 0.00000000 ,-0.00000000 ,-0.00000000 , 0.00000000 ,-0.00000000 ,-0.00000000 ],\
            [-0.00000000 , 0.00000000 ,-0.00000000 ,-0.00985673 ,-0.00000000 , 0.00000000 ]]],
          [[[ 0.00000000 ,-0.00000000 ,-0.00000000 ,-0.00000000 ,-0.00490897 , 0.00000000 ],\
            [ 0.00000000 , 0.00000000 ,-0.00000000 ,-0.00000000 ,-0.00374626 ,-0.00000000 ],\
            [-0.00000000 , 0.00000000 , 0.00000000 ,-0.00000000 ,-0.00512844 ,-0.00000000 ],\
            [-0.00000000 , 0.00000000 , 0.00000000 ,-0.00000000 , 0.00000000 , 0.00000000 ],\
            [-0.19815946 , 0.00218343 , 0.00248687 ,-0.00000000 ,-0.00000000 ,-0.00028653 ],\
            [ 0.00000000 , 0.00000000 ,-0.00000000 , 0.00000000 , 0.00305410 ,-0.00000000 ]],
           [[-0.00000000 , 0.00000000 , 0.00000000 ,-0.00000000 ,-0.00374626 ,-0.00000000 ],\
            [ 0.00000000 , 0.00000000 ,-0.00000000 ,-0.00000000 ,-0.01172506 , 0.00000000 ],\
            [ 0.00000000 ,-0.00000000 , 0.00000000 ,-0.00000000 ,-0.00963631 ,-0.00000000 ],\
            [ 0.00000000 ,-0.00000000 , 0.00000000 ,-0.00000000 , 0.00000000 ,-0.00000000 ],\
            [ 0.00218343 ,-0.13520908 ,-0.00285645 , 0.00000000 , 0.00000000 , 0.00801845 ],\
            [ 0.00000000 , 0.00000000 ,-0.00000000 , 0.00000000 , 0.00978740 , 0.00000000 ]],
           [[-0.00000000 , 0.00000000 , 0.00000000 ,-0.00000000 ,-0.00512844 ,-0.00000000 ],\
            [-0.00000000 ,-0.00000000 , 0.00000000 ,-0.00000000 ,-0.00963631 ,-0.00000000 ],\
            [ 0.00000000 , 0.00000000 ,-0.00000000 ,-0.00000000 ,-0.02063890 ,-0.00000000 ],\
            [ 0.00000000 , 0.00000000 ,-0.00000000 ,-0.00000000 , 0.00000000 ,-0.00000000 ],\
            [ 0.00248687 ,-0.00285645 ,-0.14100189 ,-0.00000000 ,-0.00000000 ,-0.00109727 ],\
            [-0.00000000 ,-0.00000000 , 0.00000000 , 0.00000000 , 0.00686606 ,-0.00000000 ]],
           [[-0.00000000 ,-0.00000000 ,-0.00000000 , 0.00000000 , 0.00000000 , 0.00000000 ],\
            [-0.00000000 ,-0.00000000 ,-0.00000000 , 0.00000000 , 0.00000000 , 0.00000000 ],\
            [-0.00000000 ,-0.00000000 ,-0.00000000 ,-0.00000000 , 0.00000000 , 0.00000000 ],\
            [-0.00000000 ,-0.00000000 ,-0.00000000 , 0.00000000 ,-0.00843457 , 0.00000000 ],\
            [-0.00000000 , 0.00000000 ,-0.00000000 ,-0.13960362 ,-0.00000000 , 0.00000000 ],\
            [ 0.00000000 , 0.00000000 , 0.00000000 , 0.00000000 ,-0.00000000 ,-0.00000000 ]],
           [[-0.00490897 ,-0.00374626 ,-0.00512844 , 0.00000000 ,-0.00000000 , 0.00305410 ],\
            [-0.00374626 ,-0.01172506 ,-0.00963631 , 0.00000000 , 0.00000000 , 0.00978740 ],\
            [-0.00512844 ,-0.00963631 ,-0.02063890 , 0.00000000 ,-0.00000000 , 0.00686606 ],\
            [ 0.00000000 , 0.00000000 , 0.00000000 ,-0.00843457 ,-0.00000000 ,-0.00000000 ],\
            [-0.00000000 , 0.00000000 ,-0.00000000 ,-0.00000000 ,-0.15647276 , 0.00000000 ],\
            [ 0.00305410 , 0.00978740 , 0.00686606 ,-0.00000000 , 0.00000000 ,-0.00985673 ]],
           [[ 0.00000000 ,-0.00000000 ,-0.00000000 , 0.00000000 , 0.00305410 , 0.00000000 ],\
            [-0.00000000 , 0.00000000 ,-0.00000000 , 0.00000000 , 0.00978740 , 0.00000000 ],\
            [-0.00000000 ,-0.00000000 ,-0.00000000 , 0.00000000 , 0.00686606 ,-0.00000000 ],\
            [ 0.00000000 ,-0.00000000 ,-0.00000000 , 0.00000000 ,-0.00000000 ,-0.00000000 ],\
            [-0.00028653 , 0.00801845 ,-0.00109727 , 0.00000000 , 0.00000000 ,-0.13409712 ],\
            [-0.00000000 , 0.00000000 ,-0.00000000 ,-0.00000000 ,-0.00985673 , 0.00000000 ]]],
          [[[-0.02631908 , 0.00443919 , 0.00115433 ,-0.00000000 , 0.00000000 ,-0.00424586 ],\
            [ 0.02045706 ,-0.00237063 ,-0.00025079 ,-0.00000000 ,-0.00000000 ,-0.00006379 ],\
            [-0.00882298 , 0.00184650 ,-0.00220044 , 0.00000000 ,-0.00000000 ,-0.00215110 ],\
            [ 0.00000000 , 0.00000000 , 0.00000000 , 0.00305410 , 0.00000000 ,-0.00000000 ],\
            [ 0.00000000 , 0.00000000 ,-0.00000000 , 0.00000000 , 0.00305410 ,-0.00000000 ],\
            [-0.18087141 ,-0.00165839 , 0.00566870 ,-0.00000000 , 0.00000000 , 0.00151402 ]],
           [[ 0.00443919 , 0.00340244 ,-0.00083494 ,-0.00000000 ,-0.00000000 ,-0.00006379 ],\
            [-0.00237063 ,-0.06352614 , 0.01727050 , 0.00000000 , 0.00000000 ,-0.06193616 ],\
            [ 0.00184650 , 0.02567039 ,-0.00467873 ,-0.00000000 ,-0.00000000 , 0.01592852 ],\
            [ 0.00000000 , 0.00000000 ,-0.00000000 , 0.00978740 , 0.00000000 , 0.00000000 ],\
            [ 0.00000000 , 0.00000000 ,-0.00000000 , 0.00000000 , 0.00978740 , 0.00000000 ],\
            [-0.00165839 ,-0.22702098 , 0.02164705 , 0.00000000 , 0.00000000 ,-0.06726437 ]],
           [[ 0.00115433 ,-0.00083494 ,-0.00520404 , 0.00000000 ,-0.00000000 ,-0.00215110 ],\
            [-0.00025079 , 0.01727050 , 0.00614209 ,-0.00000000 ,-0.00000000 , 0.01592852 ],\
            [-0.00220044 ,-0.00467873 ,-0.01799095 , 0.00000000 ,-0.00000000 ,-0.01321835 ],\
            [ 0.00000000 ,-0.00000000 , 0.00000000 , 0.00686606 , 0.00000000 ,-0.00000000 ],\
            [-0.00000000 ,-0.00000000 , 0.00000000 , 0.00000000 , 0.00686606 ,-0.00000000 ],\
            [ 0.00566870 , 0.02164705 ,-0.12073391 ,-0.00000000 ,-0.00000000 , 0.02202612 ]],
           [[-0.00000000 ,-0.00000000 , 0.00000000 ,-0.00028653 ,-0.00000000 ,-0.00000000 ],\
            [-0.00000000 , 0.00000000 ,-0.00000000 , 0.00801845 , 0.00000000 , 0.00000000 ],\
            [ 0.00000000 ,-0.00000000 , 0.00000000 ,-0.00109727 ,-0.00000000 ,-0.00000000 ],\
            [ 0.00305410 , 0.00978740 , 0.00686606 , 0.00000000 , 0.00000000 ,-0.00985673 ],\
            [ 0.00000000 , 0.00000000 , 0.00000000 , 0.00000000 ,-0.00000000 ,-0.00000000 ],\
            [-0.00000000 , 0.00000000 ,-0.00000000 ,-0.13409712 ,-0.00000000 , 0.00000000 ]],
           [[ 0.00000000 ,-0.00000000 ,-0.00000000 ,-0.00000000 ,-0.00028653 ,-0.00000000 ],\
            [-0.00000000 , 0.00000000 ,-0.00000000 , 0.00000000 , 0.00801845 , 0.00000000 ],\
            [-0.00000000 ,-0.00000000 ,-0.00000000 ,-0.00000000 ,-0.00109727 ,-0.00000000 ],\
            [ 0.00000000 , 0.00000000 , 0.00000000 , 0.00000000 , 0.00000000 ,-0.00000000 ],\
            [ 0.00305410 , 0.00978740 , 0.00686606 ,-0.00000000 , 0.00000000 ,-0.00985673 ],\
            [ 0.00000000 , 0.00000000 ,-0.00000000 ,-0.00000000 ,-0.13409712 , 0.00000000 ]],
           [[-0.00424586 ,-0.00006379 ,-0.00215110 ,-0.00000000 ,-0.00000000 , 0.00151402 ],\
            [-0.00006379 ,-0.06193616 , 0.01592852 , 0.00000000 , 0.00000000 ,-0.06726437 ],\
            [-0.00215110 , 0.01592852 ,-0.01321835 ,-0.00000000 ,-0.00000000 , 0.02202612 ],\
            [-0.00000000 , 0.00000000 ,-0.00000000 ,-0.00985673 ,-0.00000000 , 0.00000000 ],\
            [-0.00000000 , 0.00000000 ,-0.00000000 ,-0.00000000 ,-0.00985673 , 0.00000000 ],\
            [ 0.00151402 ,-0.06726437 , 0.02202612 , 0.00000000 , 0.00000000 ,-0.22697926 ]]]])
        self.nucl_dip = numpy.array([0.,0.,7.66111134])
        self.el_dip_FCI_ref = numpy.array([    -0.00000000,     0.00000000,    12.28128360])
        self.edip_mo_mat = numpy.array(\
           [[[-0.00000000 , 0.00000000 ,-0.00000000 , 0.07922777 , 0.19053374 , 0.00000000 ],\
             [ 0.00000000 , 0.00000000 , 0.00000000 , 0.37471666 , 0.90115080 ,-0.00000000 ],\
             [-0.00000000 , 0.00000000 ,-0.00000000 , 0.52411265 , 1.26043111 , 0.00000000 ],\
             [ 0.07922777 , 0.37471666 , 0.52411265 , 0.00000000 , 0.00000000 ,-0.33275060 ],\
             [ 0.19053374 , 0.90115080 , 1.26043111 , 0.00000000 ,-0.00000000 ,-0.80022722 ],\
             [ 0.00000000 ,-0.00000000 , 0.00000000 ,-0.33275060 ,-0.80022722 ,-0.00000000 ]],
            [[-0.00000000 , 0.00000000 ,-0.00000000 , 0.19053374 ,-0.07922777 , 0.00000000 ],\
             [ 0.00000000 , 0.00000000 ,-0.00000000 , 0.90115080 ,-0.37471666 , 0.00000000 ],\
             [-0.00000000 ,-0.00000000 ,-0.00000000 , 1.26043111 ,-0.52411265 , 0.00000000 ],\
             [ 0.19053374 , 0.90115080 , 1.26043111 , 0.00000000 ,-0.00000000 ,-0.80022722 ],\
             [-0.07922777 ,-0.37471666 ,-0.52411265 ,-0.00000000 , 0.00000000 , 0.33275060 ],\
             [ 0.00000000 , 0.00000000 , 0.00000000 ,-0.80022722 , 0.33275060 ,-0.00000000 ]],
            [[-0.00202220 , 0.10918498 ,-0.14495223 ,-0.00000000 , 0.00000000 ,-0.11738983 ],\
             [ 0.10918498 , 2.46462318 ,-0.43083704 ,-0.00000000 ,-0.00000000 , 0.70470363 ],\
             [-0.14495223 ,-0.43083704 ,-1.63139041 ,-0.00000000 , 0.00000000 ,-0.98450481 ],\
             [-0.00000000 ,-0.00000000 ,-0.00000000 , 0.00000000 , 0.00000000 ,-0.00000000 ],\
             [ 0.00000000 ,-0.00000000 , 0.00000000 , 0.00000000 ,-0.00000000 , 0.00000000 ],\
             [-0.11738983 , 0.70470363 ,-0.98450481 ,-0.00000000 , 0.00000000 , 1.81697425 ]]])


    def test_fqe(self):
        """Checking Total energy with LiH
        """
        nele = self.nalpha + self.nbeta
        lena = int(special.binom(self.norb, self.nalpha))
        lenb = int(special.binom(self.norb, self.nbeta))
        cidim = lena*lenb
        hci = numpy.zeros((lena, lenb, lena, lenb), dtype=numpy.complex128)

        hwrap = tuple([self.h1e, self.h2e])

        for i in range(lena):
            for j in range(lenb):
                ket = FqeData(self.nalpha, self.nbeta, self.norb)
                ket.coeff[i, j] = 1.0
                ket_h = ket.apply(hwrap)
                hci[:, :, i, j] = ket_h.coeff[:, :]

        hci = numpy.reshape(hci, (cidim, cidim))
        e, v = linalg.eigh(hci)
        v = numpy.reshape(v[:,0], (lena, lenb))

        wfn = Wavefunction([[nele, self.nalpha-self.nbeta, self.norb]])
        wfn.set_wfn(strategy='from_data', raw_data={(nele, self.nalpha-self.nbeta): v})

        hwfn = wfn.apply_array(hwrap)
# Calculate the energy of the wavefunction
        err = abs(fqe.vdot(wfn, hwfn) - self.E_LiH_ref)
        self.assertTrue(err < 1.e-6)


    def test_fqe_dipole_mom(self):
        nele = self.nalpha + self.nbeta
        lena = int(special.binom(self.norb, self.nalpha))
        lenb = int(special.binom(self.norb, self.nbeta))
        au2debye = 2.5417464157449032

        hwrap = tuple([self.h1e, self.h2e])
        cidim = lena*lenb
        hci = numpy.zeros((lena, lenb, lena, lenb), dtype=numpy.complex128)

        for i in range(lena):
            for j in range(lenb):
                ket = FqeData(self.nalpha, self.nbeta, self.norb)
                ket.coeff[i, j] = 1.0
                ket_h = ket.apply(hwrap)
                hci[:, :, i, j] = ket_h.coeff[:, :]
        hci = numpy.reshape(hci, (cidim, cidim))
        e, v = linalg.eigh(hci)
        v = numpy.reshape(v[:,0], (lena, lenb))
        wfn = Wavefunction([[nele, self.nalpha-self.nbeta, self.norb]])
        wfn.set_wfn(strategy='from_data', raw_data={(nele, self.nalpha-self.nbeta): v})

        hwfn_x = wfn.apply_array(tuple([self.edip_mo_mat[0]]))
        hwfn_y = wfn.apply_array(tuple([self.edip_mo_mat[1]]))
        hwfn_z = wfn.apply_array(tuple([self.edip_mo_mat[2]]))
        el_dip = numpy.array([fqe.vdot(wfn, hwfn_x).real, \
                              fqe.vdot(wfn, hwfn_y).real, \
                              fqe.vdot(wfn, hwfn_z).real])
        el_dip *= au2debye
        mol_dip = self.nucl_dip - el_dip
        mol_dip_ref = self.nucl_dip - self.el_dip_FCI_ref
        for card in range(3):
            with self.subTest(dip=card):
                err = abs(mol_dip[card] - mol_dip_ref[card])
                self.assertTrue(err < 1.e-5)

if __name__ == '__main__':
    unittest.main()
